<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Card Game</title>
<style>
  body { margin:0;padding:0;font-family:Arial,sans-serif;background-color:#1b2a4e;color:white;text-align:center;}
  #card-container {margin:20px auto;width:90%;max-width:400px;height:500px;perspective:1000px;}
  #card {width:100%;height:100%;border-radius:12px;background-color:#fff;color:black;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:bold;box-shadow:0 4px 10px rgba(0,0,0,0.3);cursor:pointer;transition:transform 0.6s;transform-style:preserve-3d;position:relative;}
  #card img {max-width:100%;max-height:100%;border-radius:12px;}
  #controls {display:flex;flex-wrap:wrap;justify-content:center;margin:15px 0;gap:10px;}
  button {padding:10px 15px;border-radius:8px;border:none;background-color:#3a4f8f;color:white;font-size:16px;cursor:pointer;min-width:120px;}
  button:disabled {opacity:0.5;cursor:not-allowed;}
  #history {max-width:90%;margin:0 auto 20px auto;text-align:left;background:rgba(255,255,255,0.1);padding:10px;border-radius:10px;}
  #history h3 {margin-top:0;}
  .history-item {margin:3px 0;font-size:14px;}
  #pauseOverlay, #endOverlay {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);color:white;display:none;align-items:center;justify-content:center;z-index:1000;font-size:28px;flex-direction:column;cursor:pointer;}
  #pauseOverlay button, #endOverlay button {margin-top:20px;min-width:100px;}
  @media(max-width:500px){#card-container{height:350px;}button{font-size:14px;padding:8px 12px;min-width:100px;}}
</style>
</head>
<body>
<h1>Card Game</h1>
<div id="card-container"><div id="card">Press Draw Card</div></div>
<div id="controls">
<button id="backBtn">Back</button>
<button id="drawBtn">Draw Card</button>
<button id="answeredBtn" disabled>Answered (0/3)</button>
<button id="skipBtn" disabled>Skip (0/3)</button>
<button id="pauseBtn">Pause</button>
<button id="restartLevelBtn">Restart Level</button>
<button id="restartGameBtn">Restart Game</button>
</div>
<div id="history">
<h3>History</h3>
<div id="historyList"></div>
</div>
<div id="pauseOverlay"><div>Game Paused</div><button id="resumeBtn">Resume</button></div>
<div id="endOverlay"><div>Can you go deeper? Wanna play again?</div><button id="playAgainBtn">Play Again</button></div>

<script>
/* --- Decks --- */
const decks = {
  intro:{cards:["assets_backup/intro/1.png","assets_backup/intro/2.png","assets_backup/intro/3.png","assets_backup/intro/4.png","assets_backup/intro/5.png","assets_backup/intro/6.png","assets_backup/intro/7.png","assets_backup/intro/8.png","assets_backup/intro/9.png"],sequential:true},
  level1Intro:{cards:["assets_backup/level1-intro/1.png","assets_backup/level1-intro/2.png"],sequential:true},
  level1:{cards:["assets_backup/level1/1.png","assets_backup/level1/2.png","assets_backup/level1/3.png","assets_backup/level1/4.png","assets_backup/level1/5.png","assets_backup/level1/6.png","assets_backup/level1/7.png","assets_backup/level1/8.png","assets_backup/level1/9.png","assets_backup/level1/10.png","assets_backup/level1/11.png","assets_backup/level1/12.png"],sequential:false},
  level2Intro:{cards:["assets_backup/level2-intro/1.png","assets_backup/level2-intro/2.png"],sequential:true},
  level2:{cards:["assets_backup/level2/1.png","assets_backup/level2/2.png","assets_backup/level2/3.png","assets_backup/level2/4.png","assets_backup/level2/5.png","assets_backup/level2/6.png","assets_backup/level2/7.png","assets_backup/level2/8.png","assets_backup/level2/9.png","assets_backup/level2/10.png","assets_backup/level2/11.png"],sequential:false},
  level3Intro:{cards:["assets_backup/level3-intro/1.png","assets_backup/level3-intro/2.png"],sequential:true},
  level3:{cards:["assets_backup/level3/1.png","assets_backup/level3/2.png","assets_backup/level3/3.png","assets_backup/level3/4.png","assets_backup/level3/5.png","assets_backup/level3/6.png","assets_backup/level3/7.png","assets_backup/level3/8.png","assets_backup/level3/9.png","assets_backup/level3/10.png","assets_backup/level3/11.png","assets_backup/level3/12.png"],sequential:false},
  infinityIntro:{cards:["assets_backup/infinity-intro/1.png","assets_backup/infinity-intro/2.png"],sequential:true},
  infinity:{cards:["assets_backup/infinity/1.png","assets_backup/infinity/2.png","assets_backup/infinity/3.png","assets_backup/infinity/4.png","assets_backup/infinity/5.png","assets_backup/infinity/6.png","assets_backup/infinity/7.png","assets_backup/infinity/8.png","assets_backup/infinity/9.png","assets_backup/infinity/10.png"],sequential:false}
};
const sequence=["intro","level1Intro","level1","level2Intro","level2","level3Intro","level3","infinityIntro","infinity"];

/* --- State --- */
let currentStageIndex=0, currentDeck=[], currentCardIndex=0, skippedCards={level1:[],level2:[],level3:[],infinity:[]};
let answeredThisRound=0, skipThisRound=0, cardHistory=[], restartLevelIntro=false, lastCard=null;
let playedCards={level1:new Set(),level2:new Set(),level3:new Set(),infinity:new Set()};
const totalMainCards=decks.level1.cards.length+decks.level2.cards.length+decks.level3.cards.length+decks.infinity.cards.length;

/* --- DOM --- */
const cardEl=document.getElementById("card"), drawBtn=document.getElementById("drawBtn"), answeredBtn=document.getElementById("answeredBtn"), skipBtn=document.getElementById("skipBtn");
const backBtn=document.getElementById("backBtn"), pauseBtn=document.getElementById("pauseBtn"), restartLevelBtn=document.getElementById("restartLevelBtn"), restartGameBtn=document.getElementById("restartGameBtn");
const historyList=document.getElementById("historyList"), pauseOverlay=document.getElementById("pauseOverlay"), resumeBtn=document.getElementById("resumeBtn");
const endOverlay=document.getElementById("endOverlay"), playAgainBtn=document.getElementById("playAgainBtn");

/* --- Helpers --- */
function shuffle(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]];}return array;}
function loadDeck(stage){ 
  const deck=decks[stage];
  if(deck.sequential){ currentDeck=Array.from(deck.cards);}
  else{let baseDeck=Array.from(deck.cards);if(skippedCards[stage]&&skippedCards[stage].length>0){baseDeck=baseDeck.concat(skippedCards[stage]);skippedCards[stage]=[];}currentDeck=shuffle(baseDeck);}
  currentCardIndex=0;answeredThisRound=0;skipThisRound=0;updateCounters();
}
function showCard(cardPath){const img=document.createElement("img");img.src=cardPath;img.onerror=()=>{img.src="placeholder.png";};cardEl.innerHTML="";cardEl.appendChild(img);lastCard=cardPath;}
function updateCounters(){answeredBtn.textContent=`Answered (${answeredThisRound}/3)`;skipBtn.textContent=`Skip (${skipThisRound}/3)`;skipBtn.disabled=(skipThisRound>=3||decks[sequence[currentStageIndex]].sequential);answeredBtn.disabled=decks[sequence[currentStageIndex]].sequential||(restartLevelIntro&&sequence[currentStageIndex].includes("Intro"));}
function updateHistory(action){const div=document.createElement("div");div.className="history-item";div.textContent=`${action}: ${lastCard}`;historyList.appendChild(div);historyList.scrollTop=historyList.scrollHeight;}
function flashCounter(btn){btn.style.backgroundColor="green";setTimeout(()=>{btn.style.backgroundColor="#3a4f8f";},300);}
function allCardsPlayed(){return playedCards.level1.size===decks.level1.cards.length&&playedCards.level2.size===decks.level2.cards.length&&playedCards.level3.size===decks.level3.cards.length&&playedCards.infinity.size===decks.infinity.cards.length;}

/* --- Flow --- */
function drawNextCard(){
  const stage=sequence[currentStageIndex];const deck=decks[stage];
  // Bypass intro during Restart Level
  if(restartLevelIntro&&deck.sequential&&stage.includes("Intro")){
    showCard(currentDeck[currentCardIndex]);
    currentCardIndex++;
    drawBtn.disabled=false;answeredBtn.disabled=true;skipBtn.disabled=true;
    if(currentCardIndex>=currentDeck.length) restartLevelIntro=false;
    return;
  }
  if(deck.sequential){
    if(currentCardIndex<currentDeck.length){showCard(currentDeck[currentCardIndex]);currentCardIndex++;drawBtn.disabled=false;answeredBtn.disabled=true;skipBtn.disabled=true;}
    else{nextStage();}
  }else{
    if(answeredThisRound>=3){nextStage();return;}
    if(currentCardIndex<currentDeck.length){showCard(currentDeck[currentCardIndex]);drawBtn.disabled=false;answeredBtn.disabled=false;skipBtn.disabled=(skipThisRound>=3);}
    else{nextStage();}
  }
}

function nextStage(){
  currentStageIndex++;
  if(currentStageIndex>=sequence.length){
    if(allCardsPlayed()){showEndGameBanner();return;}
    else{currentStageIndex=1;} // restart at first main deck
  }
  loadDeck(sequence[currentStageIndex]);
  drawNextCard();
}

function showEndGameBanner(){endOverlay.style.display="flex";}
function resetGame(){endOverlay.style.display="none";currentStageIndex=0;playedCards={level1:new Set(),level2:new Set(),level3:new Set(),infinity:new Set()};loadDeck(sequence[0]);drawNextCard();}

/* --- Event Listeners --- */
drawBtn.addEventListener("click",()=>{drawNextCard();});
cardEl.addEventListener("click",()=>{const stage=sequence[currentStageIndex];if(decks[stage].sequential||!answeredBtn.disabled){drawNextCard();}});
answeredBtn.addEventListener("click",()=>{
  const stage=sequence[currentStageIndex];answeredThisRound++;if(!stage.includes("Intro"))playedCards[stage.replace("Intro","")].add(currentDeck[currentCardIndex]);cardHistory.push("Answered");updateHistory("Answered");updateCounters();
  if(answeredThisRound===3){flashCounter(answeredBtn);setTimeout(nextStage,500);}else{currentCardIndex++;drawNextCard();}
});
skipBtn.addEventListener("click",()=>{
  const stage=sequence[currentStageIndex];skipThisRound++;if(!stage.includes("Intro"))playedCards[stage.replace("Intro","")].add(currentDeck[currentCardIndex]);
  if(!decks[stage].sequential){skippedCards[stage].push(currentDeck[currentCardIndex]);}cardHistory.push("Skipped");updateHistory("Skipped");updateCounters();currentCardIndex++;drawNextCard();
});
backBtn.addEventListener("click",()=>{
  if(currentCardIndex>0){currentCardIndex--;const stage=sequence[currentStageIndex];const card=currentDeck[currentCardIndex];showCard(card);
    const lastAction=cardHistory.pop();if(lastAction==="Answered"){answeredThisRound=Math.max(0,answeredThisRound-1);flashCounter(answeredBtn);}
    else if(lastAction==="Skipped"){skipThisRound=Math.max(0,skipThisRound-1);flashCounter(skipBtn);}
    updateCounters();
  }
});
pauseBtn.addEventListener("click",()=>{pauseOverlay.style.display="flex";});
resumeBtn.addEventListener("click",()=>{pauseOverlay.style.display="none";});
pauseOverlay.addEventListener("click",()=>{pauseOverlay.style.display="none";});
document.addEventListener("keydown",(e)=>{if(e.key==="Escape"){pauseOverlay.style.display="none";}});
restartLevelBtn.addEventListener("click",()=>{
  const stage=sequence[currentStageIndex];
  const mainStage=stage.includes("Intro")?sequence[currentStageIndex+1]:sequence[currentStageIndex];
  restartLevelIntro=true;
  currentDeck=[...decks[mainStage.replace(/Intro$/,"Intro")].cards,...shuffle(decks[mainStage].cards)];
  currentCardIndex=0;answeredThisRound=0;skipThisRound=0;cardHistory=[];updateCounters();drawNextCard();
});
restartGameBtn.addEventListener("click",()=>{resetGame();cardHistory=[];});
playAgainBtn.addEventListener("click",()=>{resetGame();});
endOverlay.addEventListener("click",()=>{resetGame();});
document.addEventListener("keydown",(e)=>{if(endOverlay.style.display==="flex"){resetGame();}});

/* --- Init --- */
loadDeck(sequence[currentStageIndex]);
</script>
</body>
</html>
